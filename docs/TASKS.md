# WA-Agent 开发任务清单

基于 PRD.md 和 DEVELOPMENT.md 的完整开发任务列表

---

## 🎯 项目总览

- **项目类型**: 多租户 WhatsApp 智能客服 SaaS 平台  
- **技术栈**: Cloudflare 全家桶 + React + Hono  
- **核心特性**: 双层人工介入 + 智能消息合并 + RAG 知识库  
- **开发周期**: 8-10 周（MVP + 增强 + 生产）

---

## 📋 第一阶段：基础设施与认证（2周）

### ✅ T001 - 项目初始化与环境配置 **[已完成]**
**优先级**: P0 | **预估时间**: 1天 | **依赖**: 无 | **实际用时**: 1天

**任务描述**: 
创建项目结构，配置开发环境

**检查列表**:
- [x] ✅ 创建扁平项目结构（src/ + frontend/）
- [x] ✅ 配置 Cloudflare Workers 开发环境
- [x] ✅ 设置 wrangler.toml 配置文件
- [x] ✅ 配置环境变量管理（.dev.vars）
- [x] ✅ 设置 TypeScript + Biome（语法检查和代码格式化）
- [x] ✅ 创建 README.md 和基础文档
- [x] ✅ 配置 package.json 脚本

**验收标准**:
- ✅ `bun run dev` 能正常启动开发环境
- ✅ 所有环境变量配置正确  
- ✅ TypeScript 编译无错误，Biome 检查通过
- ✅ Hono 基础应用运行正常

**完成情况**: 
✅ 项目结构建立，开发环境配置完成，TypeScript + Biome 集成成功

---

### ✅ T002 - 数据库设计与迁移 **[已完成]**
**优先级**: P0 | **预估时间**: 2天 | **依赖**: T001 | **实际用时**: 1.5天

**任务描述**: 
实现 D1 数据库设计和 Drizzle ORM 配置

**检查列表**:
- [x] ✅ 安装和配置 Drizzle ORM + Drizzle-Zod
- [x] ✅ 创建数据库 schema 文件（schema/index.ts）
- [x] ✅ 实现用户表 (users) 及索引
- [x] ✅ 实现知识库相关表 (kb_spaces, kb_documents, kb_chunks)
- [x] ✅ 实现智能体表 (agents) 和关联表 (agent_kb_links)
- [x] ✅ 实现 WhatsApp 相关表 (wa_sessions, conversations, messages, jobs)
- [x] ✅ 创建数据库迁移脚本
- [x] ✅ 配置本地和远程 D1 连接
- [x] ✅ 创建种子数据脚本和测试脚本

**验收标准**:
- ✅ `bun run db:generate` 生成正确的迁移文件
- ✅ `bun run db:push:local` 和 `db:push:remote` 成功执行  
- ✅ 所有表创建成功，约束和索引正确
- ✅ `bun run db:seed` 种子数据插入成功

**完成情况**:
✅ 完整的10张表数据库架构，Drizzle ORM类型安全集成，种子数据和测试工具完善

---

### ✅ T003 - Better Auth 认证系统 **[已完成]**
**优先级**: P0 | **预估时间**: 2天 | **依赖**: T002 | **实际用时**: 1天

**任务描述**: 
实现 Google OAuth 登录和用户管理

**检查列表**:
- [x] ✅ 安装和配置 Better Auth
- [x] ✅ 配置 Google OAuth 应用（dev/prod）
- [x] ✅ 实现 Better Auth 中间件
- [x] ✅ 创建认证相关 API 路由
- [x] ✅ 实现用户注册流程（待审核状态）
- [x] ✅ 实现用户会话管理
- [x] ⚠️ 实现权限控制中间件（超级管理员 vs 普通用户）- 基础版完成
- [x] ⚠️ 创建用户管理 API - 基础结构完成

**验收标准**:
- ✅ Google 一键登录功能正常
- ✅ 新用户注册后处于 `verified=0` 状态
- ✅ 会话管理和自动登出功能正常
- ✅ 权限控制中间件正确拦截未授权请求
- ✅ 用户信息正确存储到 D1 数据库

**完成情况**:
✅ Better Auth 集成完成，Google OAuth 配置就绪，认证系统基础框架建立，演示页面可用

---

### ✅ T004 - 基础 API 框架 **[已完成]**
**优先级**: P0 | **预估时间**: 1天 | **依赖**: T003 | **实际用时**: 1天

**任务描述**: 
建立 Hono RPC API 基础框架

**检查列表**:
- [x] ✅ 配置 Hono 应用和中间件
- [x] ✅ 实现 Hono RPC 类型安全的路由
- [x] ✅ 配置请求验证（Zod）
- [x] ✅ 实现错误处理中间件
- [x] ✅ 实现请求日志和指标收集中间件
- [x] ✅ 配置 CORS 和安全头
- [x] ✅ 创建健康检查端点 (`/api/health`)

**验收标准**:
- ✅ API 路由响应正常，类型安全
- ✅ 错误处理统一，返回标准格式
- ✅ 请求日志记录完整
- ✅ 健康检查端点返回系统状态

**完成情况**:
✅ Hono RPC 框架完整搭建，Zod 验证集成，统一错误处理，请求日志监控，测试端点全部正常，类型安全保障

---

## 📚 第二阶段：知识库系统（2周）

### T005 - 文件上传与存储 ✅
**优先级**: P0 | **预估时间**: 2天 | **依赖**: T004 | **完成日期**: 2025-09-07

**任务描述**: 
实现多格式文件上传到 R2 存储

**检查列表**:
- [x] 配置 Cloudflare R2 存储桶
- [x] 实现文件上传 API (`/api/documents/upload`)
- [x] 支持文件格式：TXT, PDF, Word, Markdown, Excel, PPT
- [x] 实现文件大小限制（50MB）和格式验证
- [x] 实现安全的文件命名和存储路径
- [x] 创建文件元数据记录（kb_documents 表）
- [x] 实现文件删除和清理功能
- [x] 添加上传进度和状态跟踪

**验收标准**:
- ✅ 支持的文件格式都能正确上传
- ✅ 文件存储到 R2，元数据保存到 D1
- ✅ 文件大小和格式限制正确生效
- ✅ 文件上传状态实时更新
- ✅ 删除文件时同时清理 R2 和 D1 记录

**完成情况**:
✅ 完整的文件上传系统实现，支持9种文件格式，R2存储集成，数据库元数据管理，文件验证和安全命名，CRUD API完成

---

### T006 - 文档解析与处理 ✅
**优先级**: P0 | **预估时间**: 3天 | **依赖**: T005 | **完成日期**: 2025-09-07

**任务描述**: 
实现多格式文档内容提取和切片

**检查列表**:
- [x] 实现 PDF 内容提取（pdf-parse 或类似库）
- [x] 实现 Word 文档提取（docx 解析）
- [x] 实现 Excel 表格提取
- [x] 实现 PPT 内容提取
- [x] 实现 Markdown 和 TXT 处理
- [x] 创建文档切片算法（1000字符，200字符重叠）
- [x] 实现内容清理和格式化
- [x] 添加切片质量检查
- [x] 将切片保存到 kb_chunks 表

**验收标准**:
- ✅ 各种格式文档内容正确提取
- ✅ 文档切片大小符合规范（1000±100字符）
- ✅ 切片重叠区域正确处理（200字符）
- ✅ 切片内容质量良好，无乱码
- ✅ 切片元数据正确保存到数据库

**完成情况**:
✅ 完整的文档处理系统，支持PDF/Word/Excel/PowerPoint/Text/Markdown，智能切片算法，质量验证，处理API端点完成

---

### ✅ T007 - 网页内容抓取 **[已完成]**
**优先级**: P1 | **预估时间**: 2天 | **依赖**: T006 | **实际用时**: 2天

**任务描述**: 
实现 URL 和 Sitemap 批量内容抓取

**检查列表**:
- [x] ✅ 实现单个 URL 内容抓取
- [x] ✅ 实现 Sitemap XML 解析
- [x] ✅ 添加内容清理（去除广告、导航等）
- [x] ✅ 实现批量抓取队列处理
- [x] ✅ 添加抓取频率限制和错误重试
- [x] ✅ 支持常见网站结构识别
- [x] ✅ 添加抓取状态跟踪和进度显示
- [x] ✅ 实现内容去重机制

**验收标准**:
- ✅ 能正确抓取单个网页的主要内容
- ✅ Sitemap 批量抓取功能正常
- ✅ 抓取内容质量高，无冗余信息
- ✅ 批量抓取稳定，有错误处理
- ✅ 抓取进度实时显示

**完成情况**: 
✅ 完整的网页爬取系统，支持单URL/Sitemap/批量抓取，linkedom+fast-xml-parser集成，智能内容提取，robots.txt合规，TypeScript严格模式，完整API端点

---

### T008 - 向量化与 Vectorize 集成
**优先级**: P0 | **预估时间**: 2天 | **依赖**: T006

**任务描述**: 
集成 Cloudflare Vectorize 和 AIHubMix Embeddings

**检查列表**:
- [x] 配置 Cloudflare Vectorize 索引
- [x] 实现 AIHubMix Embeddings API 调用
- [x] 创建向量化处理队列 (`q_embed`)
- [x] 实现批量向量化处理
- [x] 添加向量 ID 映射和元数据管理
- [x] 实现向量搜索 API
- [x] 添加向量索引管理功能
- [x] 实现搜索结果排序和过滤

**验收标准**:
- ✅ 文档切片正确向量化并存入 Vectorize
- ✅ 向量搜索返回相关度高的结果
- ✅ 批量处理稳定，无数据丢失
- ✅ 向量和文本映射关系正确
- ✅ 搜索性能符合要求（<2秒）

**完成情况**: 
✅ 完整的向量化与语义搜索系统，AIHubMix embeddings集成，Cloudflare Vectorize存储，批量处理队列，完整API端点，TypeScript严格模式，与现有文档处理管道无缝集成

---

### T009 - 知识库管理 API
**优先级**: P0 | **预估时间**: 1天 | **依赖**: T007, T008

**任务描述**: 
实现知识库 CRUD 和管理功能

**检查列表**:
- [x] 实现知识库创建 API (`/rpc/kb/create`)
- [x] 实现知识库列表和详情 API
- [x] 实现知识库删除（级联删除文档和向量）
- [x] 实现文档管理 API（增删改查）
- [x] 实现知识库搜索和测试功能
- [x] 添加用户配额检查和限制
- [x] 实现知识库统计信息
- [x] 添加知识库导入导出功能（跳过 - 暂不需要）

**验收标准**:
- ✅ 知识库 CRUD 功能完整
- ✅ 用户配额限制正确生效
- ✅ 删除操作正确清理所有关联数据
- ✅ 搜索功能准确且快速
- ✅ 统计信息准确显示

---

## 🤖 第三阶段：智能体系统（1.5周）

### T010 - AIHubMix 客户端集成
**优先级**: P0 | **预估时间**: 1天 | **依赖**: T004

**任务描述**: 
实现 AIHubMix API 客户端和密钥管理

**检查列表**:
- [x] 创建 AIHubMix 客户端类
- [x] 实现 API 密钥加密存储（AES-256-GCM）
- [x] 实现聊天补全 API 调用
- [x] 实现 Embeddings API 调用
- [x] 添加模型列表和参数配置
- [x] 实现 API 密钥验证和测试
- [x] 添加错误处理和重试机制
- [x] 实现请求速率限制

**验收标准**:
- ✅ API 密钥正确加密存储
- ✅ 各种模型调用正常（GPT、Claude、Gemini等）
- ✅ 密钥验证功能正确
- ✅ 错误处理完善，有详细错误信息
- ✅ 请求限制和重试机制有效

---

### T011 - 智能体配置管理
**优先级**: P0 | **预估时间**: 2天 | **依赖**: T010

**任务描述**: 
实现智能体创建、配置和管理

**检查列表**:
- [x] 实现智能体创建 API (`/api/agents`)
- [x] 实现智能体 CRUD 操作
- [x] 添加系统提示词编辑和验证
- [x] 实现模型选择和参数配置（temperature, max_tokens）
- [x] 实现知识库关联和优先级配置
- [x] 创建智能体测试和预览功能
- [x] 添加智能体模板和预设
- [x] 实现智能体配额管理（待认证系统集成后完善）

**验收标准**:
- ✅ 智能体配置功能完整
- ✅ 提示词编辑器功能完善
- ✅ 模型参数配置正确生效
- ✅ 知识库关联功能正常
- ✅ 测试功能能准确反映配置效果

---

### ✅ T012 - 对话测试系统 **[已完成]**
**优先级**: P1 | **预估时间**: 1天 | **依赖**: T011 | **实际用时**: 1天

**任务描述**: 
实现智能体对话测试和调试功能

**检查列表**:
- [x] ✅ 创建测试对话界面 API
- [x] ✅ 实现实时对话测试
- [x] ✅ 添加知识库检索结果显示
- [x] ✅ 实现对话历史记录
- [x] ✅ 添加调试信息显示（token使用、响应时间等）
- [x] ✅ 实现测试会话管理
- [x] ✅ 添加测试用例保存和重放
- [x] ✅ 创建性能分析工具

**验收标准**:
- ✅ 测试对话响应准确
- ✅ 知识库检索结果正确显示
- ✅ 调试信息完整且有用
- ✅ 测试会话管理功能完善
- ✅ 性能数据准确记录

**完成情况**:
✅ 完整的对话测试系统，支持测试会话管理、实时对话测试、知识库检索集成、调试信息显示、测试用例管理、性能指标收集、错误分析等14个API端点，与智能体系统完全集成

---

## 📱 第四阶段：WhatsApp 集成（2周）

### ✅ T013 - WAHA API 客户端 **[已完成]**
**优先级**: P0 | **预估时间**: 2天 | **依赖**: T004

**任务描述**:
实现 WAHA API 集成和会话管理

**检查列表**:
- [x] 创建 WAHA 客户端类
- [x] 实现会话创建和管理 API
- [x] 实现 Webhook 配置和签名验证
- [x] 添加二维码获取和状态监控
- [x] 实现消息发送功能
- [x] 添加 "正在输入" 状态发送
- [x] 实现会话重连和错误恢复
- [x] 添加 WAHA 版本兼容性支持

**验收标准**:
- ✅ WAHA API 连接测试通过
- ✅ Webhook 签名验证正确
- ✅ 二维码获取和展示正常
- ✅ 消息发送功能稳定
- ✅ 会话状态监控准确

**完成情况**:
✅ 完整的WAHA API客户端集成，支持WhatsApp会话管理、二维码获取、消息发送、Webhook处理、签名验证、版本兼容性检查，包含9个API端点(/api/waha/*)和完整的Webhook处理系统(/api/webhooks/*)

---

### ✅ T014 - WhatsApp 会话管理 **[已完成]**
**优先级**: P0 | **预估时间**: 1天 | **依赖**: T013 | **实际用时**: 1天

**任务描述**: 
实现 WhatsApp 账号接入和管理

**检查列表**:
- [x] ✅ 实现会话创建 API (`/api/waha/sessions`) - 基于T013已有功能
- [x] ✅ 实现二维码轮询和状态更新 (`/api/waha/sessions/:id/poll`)
- [x] ✅ 添加会话列表和详情查看 (`/api/waha/sessions`, `/api/waha/sessions/:id`)
- [x] ✅ 实现会话重启和删除功能 (`/api/waha/sessions/:id/restart`, DELETE)
- [x] ✅ 添加连接状态实时监控 (`/api/waha/sessions/health`)
- [x] ✅ 实现用户配额检查（wa_limit）- 集成到创建会话流程
- [x] ✅ 创建会话健康检查机制 (`/api/waha/sessions/health`)
- [x] ✅ 添加会话使用统计 (`/api/waha/sessions/:id/stats`, `/api/waha/quota`)

**验收标准**:
- ✅ 会话创建流程完整，包含配额检查
- ✅ 二维码扫描和连接正常，支持轮询更新
- ✅ 状态监控实时更新，支持健康检查
- ✅ 配额限制正确生效，防止超限创建
- ✅ 会话管理功能完善，包含统计信息

**完成情况**:
✅ 完整的WhatsApp会话管理系统实现，在T013基础上增强了会话管理功能：QR码轮询更新、用户配额检查集成、会话健康监控系统、详细统计信息、12个API端点覆盖所有管理场景、与数据库系统完全集成、TypeScript严格模式兼容。

---

### ✅ T015 - Webhook 处理系统 **[已完成]**
**优先级**: P0 | **预估时间**: 2天 | **依赖**: T014 | **实际用时**: 0.5天

**任务描述**: 
实现 WAHA Webhook 接收和处理

**检查列表**:
- [x] ✅ 创建 Webhook 接收端点 (`/api/webhooks/waha/:sessionId`) - T013已实现，T015增强
- [x] ✅ 实现签名验证和安全检查 - HMAC SHA-256验证
- [x] ✅ 添加幂等性检查（KV 存储）- 24小时TTL防重复处理
- [x] ✅ 实现消息事件解析和路由 - 支持message/session.status/message.ack/call事件
- [x] ✅ 添加事件类型过滤（message, session.status）- 多事件类型支持
- [x] ✅ 实现错误处理和重试机制 - 异步处理和重试端点
- [x] ✅ 添加 Webhook 监控和日志 - KV存储指标，每日统计
- [x] ✅ 创建 Webhook 测试工具 - 增强版测试端点

**验收标准**:
- ✅ Webhook 接收响应时间 < 50ms (P95) - 使用waitUntil异步处理
- ✅ 签名验证无误报和漏报 - HMAC验证完善
- ✅ 幂等性检查防止重复处理 - KV存储消息ID
- ✅ 事件解析准确无丢失 - 多事件类型处理
- ✅ 错误处理机制完善 - 完整错误追踪

**完成情况**:
✅ 生产级Webhook处理系统：KV幂等性检查（24小时TTL）、异步处理优化（waitUntil）、实时监控指标（每日统计）、多事件类型支持（message/status/ack/call）、请求追踪（requestId）、监控端点（/api/webhooks/monitor）、重试机制、响应时间优化（<50ms）

---

## ⚡ 第五阶段：消息处理核心（2.5周）

### ✅ T016 - Durable Objects 消息合并 **[已完成]**
**优先级**: P0 | **预估时间**: 3天 | **依赖**: T015 | **实际用时**: 0.5天

**任务描述**: 
实现 ChatSessionDO 和 2秒消息合并窗口

**检查列表**:
- [x] ✅ 创建 ChatSessionDO 类和配置 - 完整实现DurableObject类
- [x] ✅ 实现消息缓冲区和合并逻辑 - 智能消息合并算法
- [x] ✅ 使用 Durable Object Alarms 实现定时器 - 2秒合并窗口
- [x] ✅ 添加强顺序处理保证 - 时间戳排序
- [x] ✅ 实现聊天键 (chatKey) 管理 - userId:waAccountId:whatsappChatId格式
- [x] ✅ 添加消息合并质量检查 - 标点符号智能连接
- [x] ✅ 实现合并窗口可配置（1.5-3秒）- 动态配置支持
- [x] ✅ 添加 DO 状态持久化和恢复 - storage API集成

**验收标准**:
- ✅ 消息在 2秒窗口内正确合并
- ✅ 长消息或结束标点立即处理
- ✅ 消息顺序严格按时间排序
- ✅ DO 故障恢复机制正常
- ✅ 合并后语义完整性保持

**完成情况**:
✅ 完整的Durable Objects消息合并系统：ChatSessionDO类实现、2秒合并窗口（Alarms API）、智能消息合并算法（标点符号感知）、强顺序保证（时间戳排序）、可配置合并窗口（1.5-3秒）、状态持久化和恢复、与Webhook系统集成、API端点（/api/message-merge/*）、测试端点验证功能

---

### T017 - 人工介入控制系统
**优先级**: P0 | **预估时间**: 2天 | **依赖**: T016

**任务描述**: 
实现双层人工介入控制机制

**检查列表**:
- [ ] 实现人工介入控制器类
- [ ] 添加 Session 级控制 API（暂停/恢复）
- [ ] 实现标点符号检测（半角逗号和句号）
- [ ] 添加优先级控制逻辑（Session > Conversation）
- [ ] 实现状态查询 API
- [ ] 创建 AI 安全剪裁函数（safeTrim）
- [ ] 添加人工介入日志和审计
- [ ] 实现状态变更通知机制

**验收标准**:
- ✅ Session 级暂停影响所有对话
- ✅ 标点符号控制立即生效
- ✅ 优先级控制逻辑正确
- ✅ AI 回复不会误触发控制
- ✅ 状态变更有完整日志记录

---

### T018 - 消息处理队列
**优先级**: P0 | **预估时间**: 3天 | **依赖**: T017

**任务描述**: 
实现完整的消息处理流水线

**检查列表**:
- [ ] 创建 q_retrieve 队列处理器
- [ ] 实现知识库向量检索逻辑
- [ ] 创建 q_infer 队列处理器
- [ ] 实现 AI 推理和上下文管理
- [ ] 创建 q_reply 队列处理器
- [ ] 实现拟人化回复处理
- [ ] 添加队列兜底检查机制
- [ ] 实现消息状态跟踪

**验收标准**:
- ✅ 检索队列准确找到相关知识
- ✅ 推理队列生成高质量回复
- ✅ 回复队列实现拟人化处理
- ✅ 兜底检查防止误发消息
- ✅ 端到端处理时间 < 3秒

---

### T019 - 拟人化回复系统
**优先级**: P1 | **预估时间**: 2天 | **依赖**: T018

**任务描述**: 
实现自然的拟人化消息回复

**检查列表**:
- [ ] 实现 "正在输入" 状态模拟
- [ ] 添加回复延迟计算（20-60 WPM）
- [ ] 实现消息智能分段功能
- [ ] 添加随机延迟增加真实感
- [ ] 实现段间延迟控制
- [ ] 创建拟人化参数配置
- [ ] 添加回复节奏优化
- [ ] 实现消息发送错误重试

**验收标准**:
- ✅ 输入状态显示时间合理
- ✅ 消息分段位置恰当
- ✅ 回复节奏自然不会过快
- ✅ 用户体验接近真人对话
- ✅ 发送错误有重试机制

---

## 🎨 第六阶段：前端开发（2周）

### T020 - 前端基础架构
**优先级**: P0 | **预估时间**: 2天 | **依赖**: T004

**任务描述**: 
建立 React 前端应用基础架构

**检查列表**:
- [ ] 创建 React + TypeScript + Vite 项目
- [ ] 配置 TanStack Router 路由系统
- [ ] 配置 TanStack Query 状态管理
- [ ] 安装和配置 Radix UI + Tailwind CSS
- [ ] 配置 Hono RPC 客户端
- [ ] 创建基础布局和导航组件
- [ ] 配置认证状态管理
- [ ] 设置环境配置和构建流程

**验收标准**:
- ✅ 前端项目正确启动和构建
- ✅ 路由系统工作正常
- ✅ API 调用类型安全
- ✅ UI 组件库正确配置
- ✅ 认证状态管理完善

---

### T021 - 用户认证界面
**优先级**: P0 | **预估时间**: 1天 | **依赖**: T020, T003

**任务描述**: 
实现用户登录和个人设置界面

**检查列表**:
- [ ] 创建登录页面和 Google OAuth 集成
- [ ] 实现用户注册流程和状态显示
- [ ] 创建个人设置页面
- [ ] 实现 AIHubMix API Key 配置
- [ ] 添加配额使用情况显示
- [ ] 实现用户信息编辑
- [ ] 添加登出功能
- [ ] 创建待审核状态提示

**验收标准**:
- ✅ Google 登录流程顺畅
- ✅ 用户状态正确显示
- ✅ API Key 设置功能正常
- ✅ 配额信息准确展示
- ✅ 用户体验友好

---

### T022 - 知识库管理界面
**优先级**: P0 | **预估时间**: 3天 | **依赖**: T021, T009

**任务描述**: 
实现知识库管理相关界面

**检查列表**:
- [ ] 创建知识库列表和卡片组件
- [ ] 实现知识库创建和编辑表单
- [ ] 创建文件上传界面和进度显示
- [ ] 实现 URL/Sitemap 抓取界面
- [ ] 添加文档列表和管理界面
- [ ] 实现知识库搜索和测试功能
- [ ] 创建处理状态和进度显示
- [ ] 添加删除确认和批量操作

**验收标准**:
- ✅ 知识库操作流程完整
- ✅ 文件上传体验良好
- ✅ 处理进度实时更新
- ✅ 搜索功能准确快速
- ✅ 错误处理和提示完善

---

### T023 - 智能体配置界面
**优先级**: P0 | **预估时间**: 2天 | **依赖**: T022, T012

**任务描述**: 
实现智能体创建和配置界面

**检查列表**:
- [ ] 创建智能体列表和管理界面
- [ ] 实现智能体创建和编辑表单
- [ ] 创建系统提示词编辑器（代码高亮）
- [ ] 实现模型选择和参数配置界面
- [ ] 添加知识库关联和优先级配置
- [ ] 创建智能体测试对话界面
- [ ] 实现配置预览和导出功能
- [ ] 添加智能体模板选择

**验收标准**:
- ✅ 智能体配置界面直观易用
- ✅ 提示词编辑器功能完善
- ✅ 参数配置实时生效
- ✅ 测试功能响应准确
- ✅ 配置保存和加载正常

---

### T024 - WhatsApp 机器人管理界面
**优先级**: P0 | **预估时间**: 2天 | **依赖**: T023, T014

**任务描述**: 
实现 WhatsApp 机器人接入和管理界面

**检查列表**:
- [ ] 创建机器人列表和状态显示
- [ ] 实现 WAHA API 配置表单
- [ ] 创建二维码展示和扫描界面
- [ ] 实现连接状态实时监控
- [ ] 添加机器人操作按钮（重启、删除）
- [ ] 创建机器人和智能体关联界面
- [ ] 实现连接测试和诊断功能
- [ ] 添加使用统计和状态历史

**验收标准**:
- ✅ 机器人接入流程清晰
- ✅ 二维码展示和状态更新正常
- ✅ 机器人状态监控准确
- ✅ 操作功能响应及时
- ✅ 关联配置界面友好

---

### T025 - 对话管理和人工介入界面
**优先级**: P0 | **预估时间**: 2天 | **依赖**: T024, T017

**任务描述**: 
实现对话记录查看和人工介入控制

**检查列表**:
- [ ] 创建对话列表和搜索界面
- [ ] 实现对话记录详情查看
- [ ] 添加人工介入控制按钮
- [ ] 创建 Session 级暂停/恢复界面
- [ ] 实现对话状态实时更新
- [ ] 添加标点符号控制说明
- [ ] 创建人工介入日志查看
- [ ] 实现批量操作功能

**验收标准**:
- ✅ 对话记录完整清晰
- ✅ 人工介入控制及时生效
- ✅ 状态变更有视觉反馈
- ✅ 操作说明清楚易懂
- ✅ 日志记录详细准确

---

### T026 - 管理员后台界面
**优先级**: P0 | **预估时间**: 2天 | **依赖**: T025

**任务描述**: 
实现超级管理员后台管理功能

**检查列表**:
- [ ] 创建管理员仪表板
- [ ] 实现用户审核和管理界面
- [ ] 添加用户配额设置功能
- [ ] 创建系统统计和监控界面
- [ ] 实现全局设置和配置
- [ ] 添加系统日志查看功能
- [ ] 创建数据导出和备份界面
- [ ] 实现系统健康检查显示

**验收标准**:
- ✅ 管理员权限控制正确
- ✅ 用户审核流程完整
- ✅ 配额管理功能完善
- ✅ 统计数据准确直观
- ✅ 系统监控信息完整

---

## 🔧 第七阶段：测试与优化（1周）

### T027 - 单元测试和集成测试
**优先级**: P1 | **预估时间**: 3天 | **依赖**: T026

**任务描述**: 
编写完整的测试套件

**检查列表**:
- [ ] 配置测试环境（Vitest/Jest）
- [ ] 编写 API 路由单元测试
- [ ] 编写数据库操作测试
- [ ] 创建人工介入系统测试
- [ ] 编写消息处理流程测试
- [ ] 添加 Durable Objects 测试
- [ ] 创建前端组件测试
- [ ] 实现端到端集成测试

**验收标准**:
- ✅ 代码覆盖率 > 80%
- ✅ 所有核心功能有测试覆盖
- ✅ 测试套件运行稳定
- ✅ 集成测试覆盖主要流程
- ✅ 测试结果可靠可重复

---

### T028 - 性能优化和监控
**优先级**: P1 | **预估时间**: 2天 | **依赖**: T027

**任务描述**: 
优化系统性能并完善监控

**检查列表**:
- [ ] 实现性能监控和指标收集
- [ ] 优化 API 响应时间（目标 <500ms P95）
- [ ] 优化 Webhook 处理时间（目标 <50ms P95）
- [ ] 优化数据库查询性能
- [ ] 添加缓存策略（KV 缓存）
- [ ] 优化前端加载性能
- [ ] 实现错误监控和告警
- [ ] 添加资源使用监控

**验收标准**:
- ✅ API 响应时间达标
- ✅ Webhook 处理时间达标
- ✅ 数据库查询优化有效
- ✅ 缓存命中率 > 70%
- ✅ 监控告警机制完善

---

### T029 - 安全加固和审计
**优先级**: P0 | **预估时间**: 2天 | **依赖**: T028

**任务描述**: 
完善系统安全措施

**检查列表**:
- [ ] 实现完整的输入验证和清理
- [ ] 加强 API 认证和授权检查
- [ ] 完善数据加密（API Key等敏感数据）
- [ ] 实现请求频率限制和防滥用
- [ ] 添加安全头和 CORS 配置
- [ ] 实现审计日志记录
- [ ] 进行安全漏洞扫描和修复
- [ ] 添加数据备份和恢复机制

**验收标准**:
- ✅ 所有输入都有验证和清理
- ✅ 认证授权机制完善
- ✅ 敏感数据正确加密存储
- ✅ 防滥用机制有效
- ✅ 安全审计无高危漏洞

---

## 🚀 第八阶段：部署与上线（1周）

### T030 - 生产环境部署
**优先级**: P0 | **预估时间**: 2天 | **依赖**: T029

**任务描述**: 
配置生产环境并完成部署

**检查列表**:
- [ ] 配置生产环境变量和密钥
- [ ] 设置 Cloudflare Workers 生产部署
- [ ] 配置生产数据库和存储
- [ ] 设置域名和 SSL 证书
- [ ] 配置 CDN 和缓存策略
- [ ] 实现蓝绿部署或滚动更新
- [ ] 配置生产监控和告警
- [ ] 创建部署脚本和文档

**验收标准**:
- ✅ 生产环境部署成功
- ✅ 所有功能在生产环境正常
- ✅ 性能指标符合要求
- ✅ 监控和告警配置完成
- ✅ 部署流程自动化

---

### T031 - 用户文档和培训材料
**优先级**: P1 | **预估时间**: 2天 | **依赖**: T030

**任务描述**: 
创建用户文档和操作指南

**检查列表**:
- [ ] 编写用户使用手册
- [ ] 创建快速开始指南
- [ ] 制作功能演示视频
- [ ] 编写 API 文档
- [ ] 创建常见问题解答
- [ ] 制作管理员操作手册
- [ ] 编写故障排除指南
- [ ] 创建用户培训材料

**验收标准**:
- ✅ 文档内容完整准确
- ✅ 操作步骤清晰易懂
- ✅ 演示视频质量良好
- ✅ API 文档详细规范
- ✅ 问题解答覆盖常见场景

---

### T032 - 系统验收和发布
**优先级**: P0 | **预估时间**: 1天 | **依赖**: T031

**任务描述**: 
最终系统验收和正式发布

**检查列表**:
- [ ] 执行完整的用户验收测试
- [ ] 验证所有功能需求实现
- [ ] 检查性能指标达标
- [ ] 确认安全措施到位
- [ ] 进行压力测试和稳定性验证
- [ ] 准备发布公告和营销材料
- [ ] 设置用户支持和反馈渠道
- [ ] 执行正式发布

**验收标准**:
- ✅ 所有 P0 功能完整实现
- ✅ 性能和安全要求达标
- ✅ 系统稳定性验证通过
- ✅ 用户体验满足设计要求
- ✅ 发布流程顺利完成

---

## 📊 任务统计

### 按优先级分布:
- **P0 (必须)**: 24 个任务
- **P1 (重要)**: 8 个任务

### 按阶段分布:
- **基础设施**: 4 个任务 (2周)
- **知识库**: 5 个任务 (2周)  
- **智能体**: 3 个任务 (1.5周)
- **WhatsApp**: 3 个任务 (2周)
- **消息处理**: 4 个任务 (2.5周)
- **前端**: 7 个任务 (2周)
- **测试优化**: 3 个任务 (1周)
- **部署**: 3 个任务 (1周)

### 总计: 32 个任务，预估 14 周

---

## ⚠️ 风险提醒

1. **第三方依赖风险**: WAHA API、AIHubMix API 可能变更
2. **Cloudflare 限制**: Workers、D1、Vectorize 可能有使用限制
3. **性能瓶颈**: 消息处理流程需要仔细优化
4. **用户体验**: 人工介入机制需要大量测试调优
5. **安全风险**: 多租户数据隔离需要特别关注

---

## 💡 开发建议

1. **并行开发**: 前后端可以并行开发，通过 Mock API 对接
2. **迭代发布**: 可以分阶段发布 MVP、增强版、完整版
3. **用户测试**: 早期邀请用户参与测试，收集反馈
4. **监控优先**: 从开发阶段就加入监控，便于调试和优化
5. **文档同步**: 开发过程中同步更新文档，避免后期遗漏